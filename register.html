<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Login Firebase + Foto Profil</title>
  <style>
    img {
      border-radius: 50%;
      margin-top: 10px;
      width: 80px;
      height: 80px;
      object-fit: cover;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"
    import {
      getAuth,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js"

    const firebaseConfig = {
      apiKey: "AIzaSyCdiK11NWJQYMWInggskQE6w1l03Qgwjfs",
      authDomain: "seismiks-nyam.firebaseapp.com",
      projectId: "seismiks-nyam"
    }

    const app = initializeApp(firebaseConfig)
    const auth = getAuth(app)
    const provider = new GoogleAuthProvider()

    async function syncUser(idToken) {
      const status = document.getElementById("status")
      try {
        const res = await fetch("http://localhost:3000/api/auth/sync", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${idToken}`
          }
        })
        const result = await res.json()
        status.innerHTML += `<br/>‚úÖ Sync success: <code>${JSON.stringify(result)}</code>`
      } catch (err) {
        status.innerHTML += `<br/>‚ùå Sync error: ${err.message}`
      }
    }

    async function handleLogin(user) {
      const idToken = await user.getIdToken()
      const status = document.getElementById("status")
      const foto = document.getElementById("foto")

      status.innerHTML = `‚úÖ Login sukses<br/>ID Token:<br/><code>${idToken}</code>`
      foto.src = user.photoURL || ''
      foto.alt = user.displayName || 'Foto profil'

      await syncUser(idToken)
    }

    async function loginEmail(event) {
      event.preventDefault()
      const email = document.getElementById("email").value
      const password = document.getElementById("password").value
      const status = document.getElementById("status")
      status.textContent = "üîÑ Logging in..."

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password)
        await handleLogin(userCredential.user)
      } catch (err) {
        status.textContent = "‚ùå Gagal login email: " + err.message
      }
    }

    async function loginGoogle() {
      const status = document.getElementById("status")
      try {
        const result = await signInWithPopup(auth, provider)
        await handleLogin(result.user)
      } catch (err) {
        status.textContent = "‚ùå Gagal login Google: " + err.message
      }
    }

    window.loginEmail = loginEmail
    window.loginGoogle = loginGoogle
  </script>
</head>
<body>
  <h2>Login Firebase</h2>
  <form onsubmit="loginEmail(event)">
    <label>Email: <input type="email" id="email" required /></label><br />
    <label>Password: <input type="password" id="password" required /></label><br />
    <button type="submit">Login Email</button>
  </form>

  <hr />
  <button onclick="loginGoogle()">Login dengan Google</button>

  <p id="status" style="white-space: pre-wrap; font-family: monospace;"></p>
  <img id="foto" src="" alt="" style="display:block;" />
</body>
</html>
